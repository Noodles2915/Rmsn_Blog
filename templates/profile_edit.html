<!doctype html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>编辑个人信息 - 一息博客</title>
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
    <style>
        :root{--bg:#f6f7fb;--card:#ffffff;--accent:#2b6cb0;--accent-hover:#1e4f7a;--muted:#6b7280;--danger:#ef4444;--border:#e6e9ef}
        html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
        .container{max-width:800px;margin:32px auto;padding:0 24px}
        .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 2px rgba(16,24,40,0.03);overflow:hidden}
        .card-header{padding:20px;border-bottom:1px solid var(--border)}
        .card-body{padding:24px}
        .avatar-preview{width:80px;height:80px;border-radius:8px;object-fit:cover;border:2px solid var(--accent)}
        .file-input-wrapper{display:flex;align-items:center;gap:16px}
        .form-actions{display:flex;gap:12px;margin-top:28px;padding-top:20px;border-top:1px solid var(--border)}
        .btn{display:inline-block;padding:8px 12px;border-radius:6px;border:1px solid transparent;text-decoration:none;cursor:pointer}
        .btn-primary{background:var(--accent);color:#fff}
        .btn-secondary{background:#f3f4f6;color:#111;border:1px solid #e5e7eb}
        .help-text{color:var(--muted);font-size:13px;margin-top:6px}
        .form-group{margin-bottom:16px}
        input[type="text"],input[type="email"],textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:6px}
        ul.error-list{color:var(--danger);margin:6px 0 0;padding-left:18px}
        @media (max-width:640px){.form-actions{flex-direction:column}.file-input-wrapper{flex-direction:column;align-items:flex-start}}
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <div class="card-header"><h2>编辑个人信息</h2></div>
        <form method="post" enctype="multipart/form-data" class="card-body">
            {% csrf_token %}

            <div class="form-section">
                <div class="form-section-title">基本信息</div>
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" id="username" value="{{ user.username }}" disabled>
                    <div class="help-text">用户名无法修改</div>
                </div>
                <div class="form-group">
                    <label for="email">邮箱地址</label>
                    {% if form.email %}{{ form.email }}{% else %}<input type="email" id="email" value="{{ user.email }}" readonly>{% endif %}
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">头像</div>
                <div class="form-group file-input">
                    <div class="file-input-wrapper">
                        <img id="avatar-preview" src="{{ user.avatar_url }}" alt="{{ user.username }}" class="avatar-preview">
                        <div style="display:flex;flex-direction:column;align-items:flex-start;gap:8px;">
                            <label for="id_avatar" class="btn btn-primary" style="padding:8px 12px;border-radius:6px;">选择新头像</label>
                            {% if user.avatar %}
                                <label class="custom-clear-checkbox" for="id_avatar-clear" style="margin-top:0;">
                                    <input type="checkbox" name="{{ form.avatar.name }}-clear" id="id_avatar-clear"><span>清除头像</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                    <input type="file" name="{{ form.avatar.name }}" id="id_avatar" accept="image/*" style="display:none;">
                    <div class="help-text">支持 JPG、PNG 格式，大小不超过 5MB。可裁剪后保存。</div>
                    {% if form.avatar.errors %}
                        <ul class="error-list">{% for error in form.avatar.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}

                    <div id="cropper-modal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
                        <div style="background:#fff;padding:24px;border-radius:12px;max-width:90vw;max-height:90vh;">
                            <img id="cropper-image" style="max-width:400px;max-height:400px;display:block;margin:auto;">
                            <div style="text-align:center;margin-top:16px;">
                                <button type="button" id="crop-confirm" class="btn btn-primary">裁剪并预览</button>
                                <button type="button" id="crop-cancel" class="btn btn-secondary">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">个人背景</div>
                <div class="form-group file-input">
                    <div class="file-input-wrapper">
                        <div id="bg-preview" style="width:240px;height:100px;border-radius:8px;border:2px solid var(--border);background: {{ user.bg_css|safe }};"></div>
                        <div style="display:flex;flex-direction:column;align-items:flex-start;gap:8px;">
                            <label for="id_bg" class="btn btn-primary" style="padding:8px 12px;border-radius:6px;">选择背景图片</label>
                            {% if user.bg %}
                                <label class="custom-clear-checkbox" for="id_bg-clear" style="margin-top:0;">
                                    <input type="checkbox" name="{{ form.bg.name }}-clear" id="id_bg-clear"><span>清除背景</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                    <input type="file" name="{{ form.bg.name }}" id="id_bg" accept="image/*" style="display:none;">
                    <div class="help-text">可选背景图片，默认为系统渐变背景。建议宽度 &gt;= 1200px。</div>
                    {% if form.bg.errors %}
                        <ul class="error-list">{% for error in form.bg.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>
            </div>

            {% if form.bio %}
            <div class="form-section">
                <div class="form-section-title">个人介绍</div>
                <div class="form-group">
                    <label for="id_bio">个人简介</label>
                    {{ form.bio }}
                    <div class="help-text">最多 500 个字符</div>
                    {% if form.bio.errors %}
                        <ul class="error-list">{% for error in form.bio.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">保存修改</button>
                <a href="{% url 'users:profile' %}" class="btn btn-secondary">取消</a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    var cropper = null;
    var avatarInput = document.getElementById('id_avatar');
    var avatarPreview = document.getElementById('avatar-preview');
    var cropperImage = document.getElementById('cropper-image');
    var cropperModal = document.getElementById('cropper-modal');

    function openCropperWithDataURL(dataURL){
        cropperImage.src = dataURL;
        cropperModal.style.display = 'flex';
    }

    if (avatarInput) {
        avatarInput.addEventListener('change', function (e) {
            var file = e.target.files && e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (ev) {
                openCropperWithDataURL(ev.target.result);
            };
            reader.readAsDataURL(file);
        });
    }

    if (cropperImage) {
        cropperImage.addEventListener('load', function () {
            if (cropper) cropper.destroy();
            cropper = new Cropper(cropperImage, { aspectRatio: 1, viewMode: 1, autoCropArea: 1 });
        });
    }

    document.getElementById('crop-cancel') && document.getElementById('crop-cancel').addEventListener('click', function () {
        cropperModal.style.display = 'none';
        if (cropper) { cropper.destroy(); cropper = null; }
    });

    document.getElementById('crop-confirm') && document.getElementById('crop-confirm').addEventListener('click', function () {
        if (!cropper) return;
        var canvas = cropper.getCroppedCanvas({ width: 256, height: 256 });
        canvas.toBlob(function (blob) {
            var file = new File([blob], 'avatar.png', { type: 'image/png' });
            var dt = new DataTransfer(); dt.items.add(file); avatarInput.files = dt.files;
            avatarPreview.src = canvas.toDataURL('image/png');
            cropperModal.style.display = 'none';
            cropper.destroy(); cropper = null;
        }, 'image/png');
    });

    var bgInput = document.getElementById('id_bg');
    var bgPreview = document.getElementById('bg-preview');
    if (bgInput) {
        bgInput.addEventListener('change', function (e) {
            var file = e.target.files && e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (ev) { bgPreview.style.background = "url('" + ev.target.result + "') center/cover no-repeat"; };
            reader.readAsDataURL(file);
        });
    }
    var bgClear = document.getElementById('id_bg-clear');
    if (bgClear) {
        bgClear.addEventListener('change', function (e) { if (e.target.checked) { bgPreview.style.background = "{{ user.bg_css|escapejs }}"; } });
    }
});
</script>
</body>
</html>
