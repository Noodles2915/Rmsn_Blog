<!doctype html>
<html lang="zh-cn" {% if user %}data-theme="{{ user.theme }}"{% endif %}>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ç¼–è¾‘ä¸ªäººä¿¡æ¯ - ä¸€æ¯åšå®¢</title>
    {% load static %}
    <link href="{% static 'netscript/cropper.min.css' %}" rel="stylesheet">
    <script src="{% static 'netscript/cropper.min.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/theme.css' %}">
<head>
    {% include '_theme_inline.html' %}
    {% load static %}
    <meta charset="utf-8">
    <header>
        <div class="brand">
            <svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="24" height="24" rx="5" fill="#2b6cb0"/>
                <text x="50%" y="55%" text-anchor="middle" fill="#fff" font-family="sans-serif" font-size="12" font-weight="700">RB</text>
            </svg>
            <h1>ä¸€æ¯åšå®¢</h1>
        </div>

        <div class="header-right">
            <a href="{% url 'users:dashboard' %}" class="back-btn">â† è¿”å›ä»ªè¡¨ç›˜</a>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div class="card-header"><h2>ç¼–è¾‘ä¸ªäººä¿¡æ¯</h2></div>
            <form method="post" enctype="multipart/form-data" class="card-body">
                {% csrf_token %}

                <div class="form-section">
                    <div class="form-section-title">é‚®ç®±åœ°å€</div>
                    <div class="form-group">
                        <label>å½“å‰é‚®ç®±</label>
                        <input type="email" value="{{ user.email }}" readonly class="form-input-readonly">
                    </div>
                    <div class="form-group">
                        <label for="id_email">æ–°é‚®ç®±</label>
                        {% if form.email %}
                            {{ form.email }}
                            {% if form.email.errors %}
                                <ul class="error-list">{% for error in form.email.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                            {% endif %}
                        {% else %}
                            <input type="email" id="id_email" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
                        {% endif %}
                    </div>

                    <div class="form-group" id="verification-section" style="display: none;">
                        <label for="id_verification_code">é‚®ç®±éªŒè¯ç </label>
                        <div class="flex-row">
                            <input type="text" name="verification_code" id="id_verification_code" maxlength="6" placeholder="6ä½éªŒè¯ç " class="vcode-input">
                            <button type="button" id="send-email-vcode" class="btn">å‘é€éªŒè¯ç </button>
                        </div>
                        <div id="vcode-msg" class="vcode-msg"></div>
                        <div class="help-text">éªŒè¯ç å°†å‘é€åˆ°æ–°é‚®ç®±åœ°å€</div>
                    </div>
                </div>

            <div class="form-section">
                <div class="form-section-title">å¤´åƒ</div>
                <div class="form-group file-input">
                    <div class="file-input-wrapper">
                        <img id="avatar-preview" src="{{ user.avatar_url }}" alt="{{ user.username }}" class="avatar-preview">
                        <div class="file-input-actions">
                            <label for="id_avatar" class="btn btn-primary">é€‰æ‹©æ–°å¤´åƒ</label>
                            {% if user.avatar %}
                                <label class="custom-clear-checkbox" for="id_avatar-clear">
                                    <input type="checkbox" name="{{ form.avatar.name }}-clear" id="id_avatar-clear"><span>æ¸…é™¤å¤´åƒ</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                    <input type="file" name="{{ form.avatar.name }}" id="id_avatar" accept="image/*" class="hidden">
                    <div class="help-text">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå¤§å°ä¸è¶…è¿‡ 5MBã€‚å¯è£å‰ªåä¿å­˜ã€‚</div>
                    {% if form.avatar.errors %}
                        <ul class="error-list">{% for error in form.avatar.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}

                    <div id="cropper-modal">
                        <div class="modal-inner">
                            <img id="cropper-image" class="cropper-image">
                            <div class="text-center mt-16">
                                <button type="button" id="crop-confirm" class="btn btn-primary">è£å‰ªå¹¶é¢„è§ˆ</button>
                                <button type="button" id="crop-cancel" class="btn btn-secondary">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">ä¸ªäººèƒŒæ™¯</div>
                <div class="form-group file-input">
                    <div class="file-input-wrapper">
                        <div id="bg-preview" class="bg-preview" style="background: {{ user.bg_css|safe }};"></div>
                        <div class="file-input-actions">
                            <label for="id_bg" class="btn btn-primary">é€‰æ‹©èƒŒæ™¯å›¾ç‰‡</label>
                            {% if user.bg %}
                                <label class="custom-clear-checkbox" for="id_bg-clear">
                                    <input type="checkbox" name="{{ form.bg.name }}-clear" id="id_bg-clear"><span>æ¸…é™¤èƒŒæ™¯</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                    <input type="file" name="{{ form.bg.name }}" id="id_bg" accept="image/*" class="hidden">
                    <div class="help-text">å¯é€‰èƒŒæ™¯å›¾ç‰‡ï¼Œé»˜è®¤ä¸ºç³»ç»Ÿæ¸å˜èƒŒæ™¯ã€‚å»ºè®®å®½åº¦ &gt;= 1200pxã€‚</div>
                    {% if form.bg.errors %}
                        <ul class="error-list">{% for error in form.bg.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>
            </div>

            <!-- ä¸»é¢˜åå¥½å·²ç§»é™¤ï¼šæ”¹ä¸ºä½¿ç”¨ç³»ç»Ÿ/ç«™ç‚¹é»˜è®¤ä¸»é¢˜ç®¡ç† -->

            {% if form.bio %}
            <div class="form-section">
                <div class="form-section-title">ä¸ªäººä»‹ç»</div>
                <div class="form-group">
                    <label for="id_bio">ä¸ªäººç®€ä»‹</label>
                    {{ form.bio }}
                    <div class="help-text">æœ€å¤š 500 ä¸ªå­—ç¬¦</div>
                    {% if form.bio.errors %}
                        <ul class="error-list">{% for error in form.bio.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="form-section">
                <div class="form-section-title">æ˜¾ç¤ºä¸»é¢˜ï¼ˆä»…å®¢æˆ·ç«¯ï¼‰</div>
                <div class="form-group">
                    <div class="help-text">æ­¤è®¾ç½®ä»…ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨ï¼Œç”¨äºåˆ‡æ¢æ—¥/å¤œ/è‡ªåŠ¨ä¸‰ç§æ˜¾ç¤ºæ¨¡å¼ã€‚</div>
                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <button type="button" class="btn" data-theme-value="light">â˜€ï¸ æ—¥é—´</button>
                        <button type="button" class="btn" data-theme-value="dark">ğŸŒ™ å¤œé—´</button>
                        <button type="button" class="btn" data-theme-value="auto">ğŸ”„ è‡ªåŠ¨</button>
                        <button type="button" class="btn" id="theme-clear-btn">âŒ æ¸…é™¤åå¥½</button>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                <a href="{% url 'users:profile' %}" class="btn btn-secondary">å–æ¶ˆ</a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // é‚®ç®±å˜åŒ–æ£€æµ‹å’ŒéªŒè¯ç é€»è¾‘
    const emailInput = document.querySelector('input[name="email"]') || document.getElementById('email');
    const originalEmail = '{{ user.email }}';
    const verificationSection = document.getElementById('verification-section');
    const sendVcodeBtn = document.getElementById('send-email-vcode');
    const vcodeInput = document.getElementById('id_verification_code');
    const vcodeMsg = document.getElementById('vcode-msg');
    
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function storageKeyFor(email) {
        return 'vcode_cooldown_' + email;
    }

    function startCooldown(seconds, email) {
        const key = storageKeyFor(email);
        const expiry = Date.now() + seconds * 1000;
        try { localStorage.setItem(key, String(expiry)); } catch (e) {}

        sendVcodeBtn.disabled = true;
        let t = seconds;
        sendVcodeBtn.textContent = `å·²å‘é€(${t}s)`;
        const iv = setInterval(() => {
            t -= 1;
            if (t <= 0) {
                clearInterval(iv);
                sendVcodeBtn.disabled = false;
                sendVcodeBtn.textContent = 'å‘é€éªŒè¯ç ';
            } else {
                sendVcodeBtn.textContent = `å·²å‘é€(${t}s)`;
            }
        }, 1000);
    }

    function checkCooldown(email) {
        const key = storageKeyFor(email);
        const expiry = localStorage.getItem(key);
        if (!expiry) return -1;
        const remaining = Math.ceil((parseInt(expiry) - Date.now()) / 1000);
        return remaining > 0 ? remaining : -1;
    }

    // ç›‘å¬é‚®ç®±è¾“å…¥å˜åŒ–
    if (emailInput) {
        emailInput.addEventListener('change', function() {
            if (this.value !== originalEmail) {
                verificationSection.style.display = 'block';
                vcodeInput.value = '';
                vcodeMsg.textContent = '';
            } else {
                verificationSection.style.display = 'none';
                vcodeInput.value = '';
                vcodeMsg.textContent = '';
            }
        });
    }

    // å‘é€éªŒè¯ç 
    if (sendVcodeBtn) {
        sendVcodeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const email = emailInput ? emailInput.value : '';
            if (!email) {
                vcodeMsg.textContent = 'è¯·è¾“å…¥é‚®ç®±åœ°å€';
                vcodeMsg.style.color = '#ef4444';
                return;
            }

            const remaining = checkCooldown(email);
            if (remaining > 0) {
                vcodeMsg.textContent = `è¯·ç­‰å¾… ${remaining} ç§’åé‡è¯•`;
                vcodeMsg.style.color = '#ef4444';
                return;
            }

            sendVcodeBtn.disabled = true;
            sendVcodeBtn.textContent = 'å‘é€ä¸­...';

            fetch('{% url "users:send_vcode" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: 'email=' + encodeURIComponent(email),
            }).then(response => response.json())
            .then(data => {
                if (data.ok) {
                    vcodeMsg.textContent = 'éªŒè¯ç å·²å‘é€';
                    vcodeMsg.style.color = '#10b981';
                    startCooldown(60, email);
                } else {
                    vcodeMsg.textContent = data.error || 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•';
                    vcodeMsg.style.color = '#ef4444';
                    sendVcodeBtn.disabled = false;
                    sendVcodeBtn.textContent = 'å‘é€éªŒè¯ç ';
                }
            }).catch(error => {
                console.error('Error:', error);
                vcodeMsg.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                vcodeMsg.style.color = '#ef4444';
                sendVcodeBtn.disabled = false;
                sendVcodeBtn.textContent = 'å‘é€éªŒè¯ç ';
            });
        });
    }

    // å®¢æˆ·ç«¯ä¸»é¢˜é€‰æ‹©ï¼ˆä»…æ›´æ”¹ localStorage/cookieï¼Œä¸ä¿®æ”¹æœåŠ¡å™¨ä¾§ user.themeï¼‰
    (function(){
        function setPref(theme){
            try { localStorage.setItem('user-theme-preference', theme); } catch(e){}
            document.cookie = 'user-theme-preference=' + encodeURIComponent(theme) + '; path=/';
            if (window.themeManager && typeof window.themeManager.setTheme === 'function') {
                window.themeManager.setTheme(theme);
            } else {
                // å›é€€ï¼šç«‹å³è®¾ç½® data-theme å¹¶åˆ·æ–°é¡µé¢
                var actual = theme === 'auto' ? (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme;
                document.documentElement.setAttribute('data-theme', actual);
            }
        }

        document.querySelectorAll('[data-theme-value]').forEach(function(btn){
            btn.addEventListener('click', function(){ setPref(btn.getAttribute('data-theme-value')); });
        });
        var clearBtn = document.getElementById('theme-clear-btn');
        if (clearBtn) clearBtn.addEventListener('click', function(){ try{ localStorage.removeItem('user-theme-preference'); document.cookie='user-theme-preference=;max-age=0;path=/'; }catch(e){}; location.reload(); });
    })();

    // å¤´åƒè£å‰ªé€»è¾‘
    var cropper = null;
    var avatarInput = document.getElementById('id_avatar');
    var avatarPreview = document.getElementById('avatar-preview');
    var cropperImage = document.getElementById('cropper-image');
    var cropperModal = document.getElementById('cropper-modal');
    var cropConfirmBtn = document.getElementById('crop-confirm');
    var cropCancelBtn = document.getElementById('crop-cancel');

    function initCropper() {
        if (cropper) {
            cropper.destroy();
        }
        cropper = new Cropper(cropperImage, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1,
            responsive: true,
            guides: true,
            center: true
        });
    }

    function openCropperWithDataURL(dataURL) {
        cropperImage.src = dataURL;
        cropperModal.style.display = 'flex';
    }

    if (avatarInput) {
        avatarInput.addEventListener('change', function (e) {
            var file = e.target.files && e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (ev) {
                openCropperWithDataURL(ev.target.result);
            };
            reader.readAsDataURL(file);
        });
    }

    if (cropperImage) {
        cropperImage.addEventListener('load', function () {
            initCropper();
        });
    }

    if (cropCancelBtn) {
        cropCancelBtn.addEventListener('click', function () {
            cropperModal.style.display = 'none';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        });
    }

    if (cropConfirmBtn) {
        cropConfirmBtn.addEventListener('click', function () {
            if (!cropper) return;
            var canvas = cropper.getCroppedCanvas({ width: 256, height: 256 });
            canvas.toBlob(function (blob) {
                var file = new File([blob], 'avatar.png', { type: 'image/png' });
                var dt = new DataTransfer();
                dt.items.add(file);
                avatarInput.files = dt.files;
                avatarPreview.src = canvas.toDataURL('image/png');
                cropperModal.style.display = 'none';
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            }, 'image/png');
        });
    }

    var bgInput = document.getElementById('id_bg');
    var bgPreview = document.getElementById('bg-preview');
    if (bgInput) {
        bgInput.addEventListener('change', function (e) {
            var file = e.target.files && e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (ev) { bgPreview.style.background = "url('" + ev.target.result + "') center/cover no-repeat"; };
            reader.readAsDataURL(file);
        });
    }
    var bgClear = document.getElementById('id_bg-clear');
    if (bgClear) {
        bgClear.addEventListener('change', function (e) { if (e.target.checked) { bgPreview.style.background = "{{ user.bg_css|escapejs }}"; } });
    }
    
    // ä¸»é¢˜é€‰æ‹©å™¨å¤„ç†
    var themeSelect = document.getElementById('id_theme');
    if (themeSelect) {
        themeSelect.addEventListener('change', function(e) {
            // å½“ç”¨æˆ·æäº¤è¡¨å•æ—¶ï¼Œä¸»é¢˜å˜åŒ–ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
            // è¿™é‡Œåªéœ€è¦å®æ—¶é¢„è§ˆï¼ˆå¯é€‰ï¼‰
        });
    }
});
</script>

    <footer>
        <div>Â© 2025 ä¸€æ¯åšå®¢ â€¢ Django å‡ºå“</div>
    </footer>
</body>
</html>
