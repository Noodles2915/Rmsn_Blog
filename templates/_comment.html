{% with offset|default:0 as depth %}
<div id="comment-{{ comment.id }}" class="comment">
    <img src="{{ comment.author.avatar_url }}" alt="{{ comment.author.username }}" class="comment-avatar">
    <div class="comment-body">
        <div class="comment-header">
            <a href="{% url 'users:profile_user' comment.author.username %}" class="comment-author-link">
                {{ comment.author.username }}
            </a>
            <span class="comment-date">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
        </div>

        <div class="comment-content">
            {{ comment.content|safe }}
        </div>

        <div class="comment-actions">
            {% if user %}
                <button class="btn-reply comment-action" data-comment-id="{{ comment.id }}">å›å¤</button>
                {% if user.id == comment.author.id or user.id == post.author.id %}
                    <button class="btn-delete-comment comment-action" data-comment-id="{{ comment.id }}">åˆ é™¤</button>
                {% endif %}
            {% else %}
                <a href="{% url 'users:login' %}?next={{ request.path }}" class="comment-action">å›å¤ï¼ˆéœ€ç™»å½•ï¼‰</a>
            {% endif %}
        </div>

        {% if user %}
        <div class="reply-form-container" id="reply-form-{{ comment.id }}" style="display: none;">
            <form method="post" action="{% url 'posting:add_comment' post.id %}" class="reply-form">
                {% csrf_token %}
                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                <div class="markdown-editor-container">
                    <div class="editor-toolbar" data-target="reply-ta-{{ comment.id }}">
                        <button type="button" class="tool" data-action="bold">B</button>
                        <button type="button" class="tool" data-action="italic">I</button>
                        <button type="button" class="tool" data-action="h2">H2</button>
                        <button type="button" class="tool" data-action="ul">â€¢ List</button>
                        <button type="button" class="tool" data-action="quote">"</button>
                        <button type="button" class="tool" data-action="code">{} </button>
                        <button type="button" class="tool" data-action="link">ğŸ”—</button>
                        <button type="button" class="tool" data-action="preview-toggle">é¢„è§ˆ</button>
                    </div>
                    <div class="editor-area">
                        <textarea id="reply-ta-{{ comment.id }}" name="content" rows="4" placeholder="å›å¤ @{{ comment.author.username }}..."></textarea>
                        <div id="reply-preview-{{ comment.id }}" class="markdown-preview preview-layer hidden">
                            <div class="preview-label">é¢„è§ˆ</div>
                            <div class="preview-content" id="reply-preview-content-{{ comment.id }}"></div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">æäº¤å›å¤</button>
                    <button type="button" class="btn-cancel-reply btn btn-secondary" data-comment-id="{{ comment.id }}">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
        {% endif %}

        <div class="replies-container">
        {% for reply in comment.replies.all %}
            {% if depth|add:0 < 6 %}
                {% include "_comment.html" with comment=reply post=post offset=depth|add:1 %}
            {% else %}
                <div class="reply-truncated">æ›´å¤šå›å¤å·²è¢«æŠ˜å </div>
            {% endif %}
        {% endfor %}
        </div>
</div>
{% endwith %}
    </div>
</div>
