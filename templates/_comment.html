<div id="comment-{{ comment.id }}" class="comment">
    <img src="{{ comment.author.avatar_url }}" alt="{{ comment.author.username }}" class="comment-avatar">
    <div class="comment-body">
        <div class="comment-header">
            <a href="{% url 'users:profile_user' comment.author.username %}" class="comment-author-link">
                {{ comment.author.username }}
            </a>
            <span class="comment-date">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
        </div>

        <div class="comment-content">
            {{ comment.content|safe }}
        </div>

        <div class="comment-actions">
            {% if user %}
                <button class="btn-reply comment-action" data-comment-id="{{ comment.id }}">回复</button>
                {% if user.id == comment.author.id or user.id == post.author.id %}
                    <button class="btn-delete-comment comment-action" data-comment-id="{{ comment.id }}">删除</button>
                {% endif %}
            {% else %}
                <a href="{% url 'users:login' %}?next={{ request.path }}" class="comment-action">回复（需登录）</a>
            {% endif %}
        </div>

        {% if user %}
        <div class="reply-form-container" id="reply-form-{{ comment.id }}" style="display: none;">
            <form method="post" action="{% url 'posting:add_comment' post.id %}" class="reply-form">
                {% csrf_token %}
                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                <textarea name="content" rows="4" placeholder="在此输入回复，支持 Markdown..."></textarea>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">提交回复</button>
                    <button type="button" class="btn-cancel-reply btn btn-secondary" data-comment-id="{{ comment.id }}">取消</button>
                </div>
            </form>
        </div>
        {% endif %}

        <div class="replies-container">
        {% for reply in comment.replies.all %}
            {% include "_comment.html" with comment=reply post=post %}
        {% endfor %}
        </div>
    </div>
</div>
