{% load static %}
<!doctype html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ post.title }} - ä¸€æ¯åšå®¢</title>
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'netscript/editor.css' %}">
    <link rel="stylesheet" href="{% static 'netscript/waifu.css' %}">
</head>
<body>
    <header>
        <div class="brand">
            <svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="24" height="24" rx="5" fill="#2b6cb0"/>
                <text x="50%" y="55%" text-anchor="middle" fill="#fff" font-family="sans-serif" font-size="12" font-weight="700">RB</text>
            </svg>
            <h1>ä¸€æ¯åšå®¢</h1>
        </div>

        <div class="nav-shortcut">
                <a href="{% url 'index' %}" class="back-btn">â† è¿”å›é¦–é¡µ</a>
                {% if user %}
                    <div class="user-actions">
                        <a href="{% url 'socials:notifications_list' %}" id="notif-link" class="action-btn">
                            <span class="action-icon">ğŸ””</span>
                            <span class="action-text">é€šçŸ¥</span>
                            <span id="notif-count" class="badge" style="display:none;">0</span>
                        </a>
                        <a href="{% url 'socials:messages_list' %}" id="msg-link" class="action-btn">
                            <span class="action-icon">âœ‰ï¸</span>
                            <span class="action-text">ç§ä¿¡</span>
                            <span id="msg-count" class="badge" style="display:none;">0</span>
                        </a>
                    </div>
                    <div class="user-dropdown" id="user-dropdown">
                        <button class="user-toggle" id="user-toggle">
                            <img src="{{ user.avatar_url }}" alt="{{ user.username }}" class="user-avatar">
                            <span class="user-name">{{ user.username }}</span>
                            <span class="chev">â–¾</span>
                        </button>
                        <div class="user-menu" id="user-menu" style="display:none;">
                            <a class="user-menu-item" href="{% url 'users:dashboard' %}">ä»ªè¡¨ç›˜</a>
                            <a class="user-menu-item" href="{% url 'users:profile_user' user.username %}">ä¸ªäººèµ„æ–™</a>
                            <a class="user-menu-item" href="{% url 'users:profile_edit' %}">ç¼–è¾‘èµ„æ–™</a>
                            <a class="user-menu-item" href="{% url 'users:logout' %}">ç™»å‡º</a>
                        </div>
                    </div>
                {% else %}
                    <a class="user-link" href="{% url 'users:login' %}">ç™»å½• / æ³¨å†Œ</a>
                {% endif %}
        </div>
    </header>

    <div class="container">
        <article>
            <header class="post-header">
                <h1 class="post-title">{{ post.title }}</h1>

                <div class="post-meta">
                    <div class="post-meta-item">
                        <div class="author-info">
                            <img src="{{ post.author.avatar_url }}" alt="{{ post.author.username }}" class="author-avatar">
                            <a href="{% url 'users:profile_user' post.author.username %}" class="link-inherit">{{ post.author.username }}</a>
                        </div>
                    </div>
                        <div class="post-meta-item">
                            ğŸ“… {{ post.created_at|date:"Y-m-d H:i" }}
                        </div>
                        {% if is_updated %}
                            <div class="post-meta-item">
                                âœï¸ ä¿®æ”¹äº {{ post.updated_at|date:"Y-m-d H:i" }}
                            </div>
                        {% endif %}
                </div>

                {% if post.tags.exists %}
                    <div class="post-tags">
                        {% for tag in post.tags.all %}
                                <a href="{% url 'posting:search_posts' %}?q={{ tag.name }}" class="tag">#{{ tag }}</a>
                        {% endfor %}
                    </div>
                {% endif %}
            </header>

            <div class="post-content">
                {{ post.content|safe }}
            </div>

            <footer class="post-footer">
                <div class="post-footer-meta">
                    <small>æœ¬æ–‡ç”± <a href="{% url 'users:profile_user' post.author.username %}" class="accent-link">{{ post.author.username }}</a> å‘å¸ƒ</small>
                </div>
                <div class="post-footer-actions">
                    <button type="button" id="like-btn" class="btn btn-secondary{% if user_liked %} liked{% endif %}" data-post-id="{{ post.id }}">
                        <span class="like-icon" id="like-icon">{% if user_liked %}â¤{% else %}ğŸ¤{% endif %}</span>
                        <span id="likes-count">{{ post.likes.count }}</span>
                    </button>
                    <button type="button" id="share-btn" class="btn btn-secondary" title="åˆ†äº«è¿™ç¯‡æ–‡ç« ">
                        <span class="share-icon">ğŸ”—</span>
                        <span>åˆ†äº«</span>
                    </button>
                    <a href="{% url 'index' %}" class="btn btn-secondary">â† è¿”å›é¦–é¡µ</a>
                </div>
            </footer>
<script>
// like button handler with enhanced animation
document.addEventListener('DOMContentLoaded', function(){
    var likeBtn = document.getElementById('like-btn');
    if(!likeBtn) return;
    
    // Create floating hearts animation
    function createFloatingHeart(x, y) {
        var heart = document.createElement('span');
        heart.textContent = 'â¤';
        heart.className = 'floating-heart';
        heart.style.left = x + 'px';
        heart.style.top = y + 'px';
        document.body.appendChild(heart);
        setTimeout(function(){ heart.remove(); }, 1000);
    }
    
    likeBtn.addEventListener('click', function(e){
        if (likeBtn._busy) return;
        likeBtn._busy = true;
        var postId = likeBtn.getAttribute('data-post-id');
        var rect = likeBtn.getBoundingClientRect();
        var csrftoken = (function(){
            var name = 'csrftoken=';
            var ca = document.cookie.split(';');
            for(var i=0;i<ca.length;i++){var c=ca[i].trim(); if(c.indexOf(name)==0) return c.substring(name.length,c.length);} return '';
        })();
        fetch(window.location.pathname + 'like/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({}),
        }).then(function(r){ return r.json(); }).then(function(data){
            var icon = document.getElementById('like-icon');
            if(data && data.ok){
                document.getElementById('likes-count').textContent = data.likes_count;
                if (data.liked) {
                    likeBtn.classList.add('liked');
                    if (icon) { 
                        icon.textContent = 'â¤';
                        icon.classList.add('like-bounce'); 
                        setTimeout(function(){ icon.classList.remove('like-bounce'); }, 600); 
                    }
                    // Create multiple floating hearts
                    for(var i=0; i<3; i++){
                        setTimeout(function(){ createFloatingHeart(rect.left + rect.width/2, rect.top); }, i * 100);
                    }
                } else {
                    likeBtn.classList.remove('liked');
                    if (icon) { 
                        icon.textContent = 'ğŸ¤';
                        icon.classList.add('like-shrink'); 
                        setTimeout(function(){ icon.classList.remove('like-shrink'); }, 300); 
                    }
                }
            } else if (data && data.error) {
                alert(data.error);
            }
        }).catch(function(){ /* ignore */ }).finally(function(){ likeBtn._busy = false; });
    });
    
    // Share button handler
    var shareBtn = document.getElementById('share-btn');
    if(shareBtn){
        shareBtn.addEventListener('click', function(e){
            e.preventDefault();
            var url = window.location.href;
            var title = document.querySelector('.post-title').textContent;
            var shareText = title + ' - ' + url;
            
            // Try modern Web Share API first
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: 'åˆ†äº«è¿™ç¯‡ç²¾å½©çš„æ–‡ç« ',
                    url: url
                }).catch(function(err){ /* user cancelled */ });
            } else if (navigator.clipboard) {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(url).then(function(){
                    // Show success feedback
                    var originalText = shareBtn.innerHTML;
                    shareBtn.innerHTML = '<span class="share-icon">âœ“</span><span>å·²å¤åˆ¶é“¾æ¥</span>';
                    shareBtn.classList.add('share-success');
                    setTimeout(function(){
                        shareBtn.innerHTML = originalText;
                        shareBtn.classList.remove('share-success');
                    }, 2000);
                }).catch(function(err){
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥ï¼š' + url);
                });
            } else {
                // Fallback for older browsers
                prompt('å¤åˆ¶ä¸‹æ–¹é“¾æ¥è¿›è¡Œåˆ†äº«ï¼š', url);
            }
        });
    }
});
</script>
        </article>

        <section class="comments-section">
            <h2>è¯„è®º</h2>

            <!-- æ–°è¯„è®ºè¡¨å• -->
            {% if user %}
            <div class="card">
                <form method="post" action="{% url 'posting:add_comment' post.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="parent_id" value="">
                    <div class="form-group markdown-editor-group">
                        <label for="comment-content">å†™ä¸‹ä½ çš„è¯„è®º (æ”¯æŒ Markdown)</label>
                        <div class="markdown-editor-container">
                            <div class="editor-toolbar" data-target="comment-content">
                                <button type="button" class="tool" data-action="bold">B</button>
                                <button type="button" class="tool" data-action="italic">I</button>
                                <button type="button" class="tool" data-action="h1">H1</button>
                                <button type="button" class="tool" data-action="h2">H2</button>
                                <button type="button" class="tool" data-action="ul">â€¢ List</button>
                                <button type="button" class="tool" data-action="ol">1. List</button>
                                <button type="button" class="tool" data-action="quote">"</button>
                                <button type="button" class="tool" data-action="code">{} </button>
                                <button type="button" class="tool" data-action="link">ğŸ”—</button>
                                <button type="button" class="tool" data-action="image">ğŸ–¼</button>
                                <button type="button" class="tool" data-action="preview-toggle">é¢„è§ˆ</button>
                            </div>
                            <div class="editor-area">
                                <textarea id="comment-content" name="content" rows="6" placeholder="åœ¨æ­¤è¾“å…¥è¯„è®ºï¼Œæ”¯æŒ Markdown æ ¼å¼..."></textarea>
                                <div id="comment-markdown-preview" class="markdown-preview preview-layer hidden">
                                    <div class="preview-label">é¢„è§ˆ</div>
                                    <div id="comment-preview-content" class="preview-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">å‘è¡¨è¯„è®º</button>
                        <button type="button" id="btn-clear-comment" class="btn btn-secondary">æ¸…ç©º</button>
                    </div>
                </form>
            </div>
            {% else %}
            <div class="card card-body text-center">
                <div class="meta mt-16">
                    <svg class="warning-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <p class="lead">è¯·ç™»å½•åå‘è¡¨è¯„è®º</p>
                    <p class="meta">æƒ³å‚ä¸è®¨è®ºï¼Ÿ<a href="{% url 'users:login' %}?next={{ request.path }}" class="accent-link">ç«‹å³ç™»å½•</a> æˆ– <a href="{% url 'users:register' %}?next={{ request.path }}" class="accent-link">æ³¨å†Œè´¦å·</a></p>
                </div>
            </div>
            {% endif %}

            <!-- å·²æœ‰è¯„è®ºï¼ˆå®¢æˆ·ç«¯æ¸²æŸ“ï¼‰ -->
            <div id="comments-list" data-post-id="{{ post.id }}">
                <!-- å½“ JS ä¸å¯ç”¨æ—¶ï¼Œä¿ç•™æœåŠ¡å™¨æ¸²æŸ“çš„å†…å®¹ä½œä¸ºå›é€€ -->
                <noscript>
                {% if comments %}
                    {% for comment in comments %}
                        {% include "_comment.html" with comment=comment offset=0 post=post %}
                    {% endfor %}
                {% else %}
                    <p>è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ã€‚</p>
                {% endif %}
                </noscript>
            </div>
        </section>
    </div>

    <footer>
        <div>Â© 2025 ä¸€æ¯åšå®¢ â€¢ Django å‡ºå“</div>
    </footer>
    <script src="{% static 'netscript/marked.min.js' %}"></script>
    <script src="{% static 'netscript/editor.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            // ç”¨æˆ·ä¸‹æ‹‰èœå•åˆ‡æ¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            (function(){
                var toggle = document.getElementById('user-toggle');
                var menu = document.getElementById('user-menu');
                if (!toggle || !menu) return;
                document.addEventListener('click', function(e){
                    if (toggle.contains(e.target)){
                            menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'flex' : 'none';
                            fetch('{% url "socials:notifications_count" %}', { headers: { 'X-Requested-With': 'XMLHttpRequest' } }).then(r=>r.json()).then(function(d){ if (d && d.count){ var n = document.getElementById('notif-count'); n.textContent = d.count; n.style.display = d.count? 'inline-block':'none'; } });
                        return;
                    }
                    if (!menu.contains(e.target)){
                        menu.style.display = 'none';
                    }
                });
                document.addEventListener('keydown', function(e){ if (e.key === 'Escape') menu.style.display = 'none'; });
                
                // Auto-refresh notification and message counts every 30 seconds
                function refreshCounts() {
                    fetch('{% url "socials:notifications_count" %}', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                        .then(r => r.json())
                        .then(function(d) {
                            if (d && d.count !== undefined) {
                                var n = document.getElementById('notif-count');
                                if (n) {
                                    n.textContent = d.count;
                                    n.style.display = d.count ? 'inline-block' : 'none';
                                }
                            }
                        })
                        .catch(err => console.error('Failed to refresh notification count', err));
                    
                    fetch('{% url "socials:messages_count" %}', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                        .then(r => r.json())
                        .then(function(d) {
                            if (d && d.count !== undefined) {
                                var m = document.getElementById('msg-count');
                                if (m) {
                                    m.textContent = d.count;
                                    m.style.display = d.count ? 'inline-block' : 'none';
                                }
                            }
                        })
                        .catch(err => console.error('Failed to refresh message count', err));
                }
                
                // Initial refresh
                refreshCounts();
                // Refresh every 30 seconds
                setInterval(refreshCounts, 30000);
            })();
            // æ¸…ç©ºæŒ‰é’®åŠŸèƒ½
            var clearBtn = document.getElementById('btn-clear-comment');
            if (clearBtn) {
                clearBtn.addEventListener('click', function(e){
                    e.preventDefault();
                    var ta = document.getElementById('comment-content');
                    if (ta) ta.value = '';
                });
            }

            // å›å¤æŒ‰é’®ï¼šæ˜¾ç¤ºå¯¹åº”å›å¤è¡¨å•å¹¶å»¶è¿Ÿåˆå§‹åŒ–ç¼–è¾‘å™¨
            function bindReplyButtons(root){
                (root || document).querySelectorAll('.btn-reply').forEach(function(btn){
                    if (btn.dataset.bound) return;
                    btn.addEventListener('click', function(e){
                        e.preventDefault();
                        var cid = this.getAttribute('data-comment-id');
                        var container = document.getElementById('reply-form-' + cid);
                        if (!container) return;
                        
                        var isHidden = container.style.display === 'none' || container.style.display === '';
                        if (isHidden) {
                            container.style.display = 'block';
                            setTimeout(function() {
                                container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 200);
                        } else {
                            container.style.display = 'none';
                        }
                    });
                    btn.dataset.bound = '1';
                });
            }

            function bindCancelButtons(root){
                (root || document).querySelectorAll('.btn-cancel-reply').forEach(function(btn){
                    if (btn.dataset.bound) return;
                    btn.addEventListener('click', function(){
                        var cid = this.getAttribute('data-comment-id');
                        var container = document.getElementById('reply-form-' + cid);
                        if (container) {
                            container.style.display = 'none';
                            var ta = container.querySelector('textarea');
                            if (ta) ta.value = '';
                        }
                    });
                    btn.dataset.bound = '1';
                });
            }

            bindReplyButtons(document);
            bindCancelButtons(document);

            // ---------- å®¢æˆ·ç«¯è¯„è®º API é€»è¾‘ ----------
            var postId = document.getElementById('comments-list').dataset.postId;
            var apiCommentsURL = '/post/api/' + postId + '/comments/';
            var apiAddCommentURL = '/post/api/' + postId + '/comment/';

            // ä»åç«¯è·å–è¯„è®ºå¹¶æ¸²æŸ“æ ‘å½¢ç»“æ„
            // è¾…åŠ©ï¼šä» cookie è·å– CSRF token
            function getCookie(name){
                var v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
                return v ? v.pop() : '';
            }

            function fetchAndRenderComments(){
                fetch(apiCommentsURL, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(function(res){ return res.json(); })
                    .then(function(data){
                        if (!data || !data.ok) return;
                        renderCommentsTree(data.comments);
                    }).catch(function(err){
                        console.error('è·å–è¯„è®ºå¤±è´¥', err);
                    });
            }

            // å°†æ‰å¹³è¯„è®ºæ•°ç»„è½¬æ¢ä¸ºæ ‘å¹¶æ¸²æŸ“
            function renderCommentsTree(flat){
                var map = {}, roots = [];
                flat.forEach(function(c){ c.children = []; map[c.id] = c; });
                flat.forEach(function(c){
                    if (c.parent && map[c.parent]){
                        map[c.parent].children.push(c);
                    } else {
                        roots.push(c);
                    }
                });

                var container = document.getElementById('comments-list');
                if (!container) return;
                container.innerHTML = '';
                if (roots.length === 0){
                    container.innerHTML = '<p>è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ã€‚</p>';
                    return;
                }
                var frag = document.createDocumentFragment();
                roots.slice().reverse().forEach(function(node){
                    frag.appendChild(createCommentNode(node));
                });
                container.appendChild(frag);
                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                bindReplyButtons(container);
                bindCancelButtons(container);
                bindDeleteButtons(container);
            }

            function createCommentNode(node){
                var wrapper = document.createElement('div');
                wrapper.id = 'comment-' + node.id;
                wrapper.className = 'comment';

                var avatar = document.createElement('img');
                avatar.className = 'comment-avatar';
                avatar.src = node.author_avatar || '/static/avatar/blank-pfp.png';
                wrapper.appendChild(avatar);

                var body = document.createElement('div');
                body.className = 'comment-body';

                var header = document.createElement('div');
                header.className = 'comment-header';
                var authorLink = document.createElement('a');
                authorLink.className = 'comment-author-link';
                authorLink.textContent = node.author || '';
                if (node.author_profile_url) authorLink.href = node.author_profile_url;
                var dateSpan = document.createElement('span');
                dateSpan.className = 'comment-date';
                dateSpan.textContent = (new Date(node.created_at)).toLocaleString();
                header.appendChild(authorLink);
                header.appendChild(dateSpan);

                var contentDiv = document.createElement('div');
                contentDiv.className = 'comment-content';
                // Prefer client-side rendering from raw markdown when available
                if (window.marked && node.content_raw !== undefined && node.content_raw !== null){
                    try{
                        contentDiv.innerHTML = marked.parse(node.content_raw || '');
                    }catch(e){
                        contentDiv.innerHTML = node.content || '';
                    }
                } else {
                    contentDiv.innerHTML = node.content || '';
                }

                var actions = document.createElement('div');
                actions.className = 'comment-actions';
                var replyBtn = document.createElement('button');
                replyBtn.className = 'btn-reply comment-action';
                replyBtn.setAttribute('data-comment-id', node.id);
                replyBtn.setAttribute('data-author', node.author || '');
                replyBtn.textContent = 'å›å¤';
                var delBtn = document.createElement('button');
                delBtn.className = 'btn-delete-comment comment-action';
                delBtn.setAttribute('data-comment-id', node.id);
                delBtn.textContent = 'åˆ é™¤';
                actions.appendChild(replyBtn);
                actions.appendChild(delBtn);

                var replyContainer = document.createElement('div');
                replyContainer.className = 'reply-form-container';
                replyContainer.id = 'reply-form-' + node.id;
                replyContainer.style.display = 'none';

                var repliesWrap = document.createElement('div');
                repliesWrap.className = 'replies-container';
                if (node.children && node.children.length){
                    node.children.forEach(function(child){
                        repliesWrap.appendChild(createCommentNode(child));
                    });
                }

                body.appendChild(header);
                body.appendChild(contentDiv);
                body.appendChild(actions);
                body.appendChild(replyContainer);
                body.appendChild(repliesWrap);

                wrapper.appendChild(body);
                return wrapper;
            }

            // ç‚¹å‡»å›å¤ï¼šåœ¨å ä½å®¹å™¨å†…æ’å…¥ä¸€ä¸ªå›å¤è¡¨å•ï¼ˆå§”æ‰˜ç»‘å®šï¼‰
            function createReplyForm(parentId, authorName){
                var html = [];
                html.push('<form class="reply-form-local" data-parent-id="' + parentId + '">');
                html.push('<div class="markdown-editor-container">');
                html.push('<div class="editor-toolbar" data-target="reply-ta-' + parentId + '">');
                html.push('<button type="button" class="tool" data-action="bold">B</button>');
                html.push('<button type="button" class="tool" data-action="italic">I</button>');
                html.push('<button type="button" class="tool" data-action="h2">H2</button>');
                html.push('<button type="button" class="tool" data-action="ul">â€¢ List</button>');
                html.push('<button type="button" class="tool" data-action="quote">"</button>');
                html.push('<button type="button" class="tool" data-action="code">{} </button>');
                html.push('<button type="button" class="tool" data-action="link">ğŸ”—</button>');
                html.push('<button type="button" class="tool" data-action="preview-toggle">é¢„è§ˆ</button>');
                html.push('</div>');
                html.push('<div class="editor-area">');
                var placeholder = authorName ? 'å›å¤ @' + authorName + '...' : 'åœ¨æ­¤è¾“å…¥å›å¤ï¼Œæ”¯æŒ Markdown...';
                html.push('<textarea id="reply-ta-' + parentId + '" name="content" rows="3" placeholder="' + placeholder + '"></textarea>');
                html.push('<div id="reply-preview-' + parentId + '" class="markdown-preview preview-layer hidden"><div class="preview-label">é¢„è§ˆ</div><div class="preview-content" id="reply-preview-content-' + parentId + '"></div></div>');
                html.push('</div>');
                html.push('<div class="form-actions"><button class="btn btn-primary" type="submit">æäº¤å›å¤</button> <button type="button" class="btn-cancel-reply btn btn-secondary" data-comment-id="' + parentId + '">å–æ¶ˆ</button></div>');
                html.push('</form>');
                return html.join('');
            }

            // äº‹ä»¶ç»‘å®šï¼ˆreply, cancel, deleteï¼‰
            function bindReplyButtons(root){
                (root || document).querySelectorAll('.btn-reply').forEach(function(btn){
                    if (btn.dataset.bound) return;
                    btn.addEventListener('click', function(e){
                        e.preventDefault();
                        var cid = this.getAttribute('data-comment-id');
                        var author = this.getAttribute('data-author') || '';
                        var container = document.getElementById('reply-form-' + cid);
                        if (!container) return;
                        if (container.innerHTML.trim() === ''){
                            container.innerHTML = createReplyForm(cid, author);
                            // ç»‘å®šæœ¬åœ°è¡¨å•æäº¤
                            var f = container.querySelector('form');
                            if (f) bindLocalReplyForm(f);
                        }
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                    btn.dataset.bound = '1';
                });
            }

            function bindLocalReplyForm(form){
                if (form.dataset.bound) return;
                form.addEventListener('submit', function(e){
                    e.preventDefault();
                    var parentId = form.dataset.parentId;
                    var ta = form.querySelector('textarea');
                    var content = ta ? ta.value.trim() : '';
                    if (!content){ alert('å›å¤å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }
                    fetch(apiAddCommentURL, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: content, parent_id: parentId })
                    }).then(function(res){ return res.json(); })
                    .then(function(data){
                        if (!data || !data.ok){ alert(data && data.error ? data.error : 'å›å¤å¤±è´¥'); return; }
                        fetchAndRenderComments();
                    }).catch(function(err){ console.error(err); alert('ç½‘ç»œé”™è¯¯'); });
                });
                form.dataset.bound = '1';
            }

            function bindCancelButtons(root){
                (root || document).querySelectorAll('.btn-cancel-reply').forEach(function(btn){
                    if (btn.dataset.bound) return;
                    btn.addEventListener('click', function(){
                        var cid = this.getAttribute('data-comment-id');
                        var container = document.getElementById('reply-form-' + cid);
                        if (container) {
                            container.style.display = 'none';
                            container.innerHTML = '';
                        }
                    });
                    btn.dataset.bound = '1';
                });
            }

            function bindDeleteButtons(root){
                (root || document).querySelectorAll('.btn-delete-comment').forEach(function(btn){
                    if (btn.dataset.bound) return;
                    btn.addEventListener('click', function(e){
                        e.preventDefault();
                        var cid = this.getAttribute('data-comment-id');
                        if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
                        fetch('/post/comment/' + cid + '/delete/', {
                            method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken') }
                        }).then(function(res){ return res.json(); })
                        .then(function(data){ if (data.ok) fetchAndRenderComments(); else alert(data.error||'åˆ é™¤å¤±è´¥'); })
                        .catch(function(err){ console.error(err); alert('åˆ é™¤å¤±è´¥'); });
                    });
                    btn.dataset.bound = '1';
                });
            }

            // åˆå§‹åŠ è½½
            fetchAndRenderComments();
            // ç»‘å®šåˆ é™¤æŒ‰é’®ï¼ˆå¯èƒ½åœ¨ noscript å›é€€æ—¶ä½¿ç”¨ï¼‰
            bindDeleteButtons(document);
            // -----------------------------------------

            
        });
    </script>
    <script src="{% static 'netscript/live2d.min.js' %}"></script>
    <script src="{% static 'netscript/autoload.js' %}"></script>
</body>
</html>
